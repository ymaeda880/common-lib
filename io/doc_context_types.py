# -*- coding: utf-8 -*-
# common_lib/io/doc_context_types.py
# ============================================================
# 文書コンテキスト（前提文書）型（UI非依存）
# - kind / text / meta を共通データ構造として固定
# ============================================================

from __future__ import annotations

from dataclasses import dataclass, asdict, field
from typing import Any, Dict, List, Optional


# ============================================================
# メタ情報（正本）
# ============================================================
@dataclass(frozen=True)
class DocContextMeta:
    # ------------------------------------------------------------
    # 入力元（共通）
    # ------------------------------------------------------------
    source_name: str = ""
    source_ext: str = ""
    extracted_chars: int = 0

    # ------------------------------------------------------------
    # 正規化（共通）
    # ------------------------------------------------------------
    truncated: bool = False
    max_chars: int = 0

    # ------------------------------------------------------------
    # 警告・備考（共通）
    # ------------------------------------------------------------
    warnings: List[str] = field(default_factory=list)

    # ------------------------------------------------------------
    # 依存不足
    # ------------------------------------------------------------
    deps_missing: List[str] = field(default_factory=list)

    # ------------------------------------------------------------
    # decode 情報（txt/md/json等）
    # ------------------------------------------------------------
    decode_strategy: str = ""

    # ------------------------------------------------------------
    # JSON
    # ------------------------------------------------------------
    json_pretty: Optional[bool] = None
    json_parse_error: Optional[bool] = None

    # ------------------------------------------------------------
    # DOCX
    # ------------------------------------------------------------
    docx_mode: Optional[str] = None

    # ------------------------------------------------------------
    # PDF
    # ------------------------------------------------------------
    pdf_mode: Optional[str] = None
    pdf_text_extracted_chars: Optional[int] = None
    pdf_seems_image_based: Optional[bool] = None
    pdf_text_threshold: Optional[int] = None
    ocr_supported: Optional[bool] = None

    # ------------------------------------------------------------
    # 変換
    # ------------------------------------------------------------
    def to_dict(self) -> Dict[str, Any]:
        return asdict(self)


# ============================================================
# 文書コンテキスト（正本）
# ============================================================
@dataclass(frozen=True)
class DocContext:
    kind: str
    text: str
    meta: DocContextMeta

    # ------------------------------------------------------------
    # 変換（session_state などに入れる用途）
    # ------------------------------------------------------------
    def to_dict(self) -> Dict[str, Any]:
        return {
            "kind": self.kind,
            "text": self.text,
            "meta": self.meta.to_dict(),
        }
